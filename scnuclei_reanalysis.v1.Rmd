---
title: "Dopamine MSNs Epigenetic Analysis"
author: "Deepak Poduval"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 8)

suppressPackageStartupMessages({
  library(Seurat)
  library(clusterProfiler)
  library(org.Hs.eg.db)
  library(tidyverse)
  library(patchwork)
  library(Matrix)
  library(ggplot2)
  library(enrichplot)
  library(edgeR)
  library(ggrepel)
})

# Create output directories
dir.create("figures", showWarnings = FALSE)
dir.create("tables", showWarnings = FALSE)

# Reproducibility for stochastic steps
set.seed(1234)
```

##Load and Initial Data Exploration
```{r load data}
# Load the RDS file
so <- readRDS("raw_data/GSE167920_Results_full_nuclei_processed_final.rds")

# Explore data structure
cat("Data Overview\n")
cat(paste("Number of cells:", ncol(so)), "\n")
cat(paste("Number of genes:", nrow(so)), "\n")
cat(paste("Available assays:", paste(names(so@assays), collapse = ", ")), "\n")

# Check metadata
cat("Metadata Columns\n")
print(colnames(so@meta.data))

# Check cell types
if ("cell_type" %in% colnames(so@meta.data)) {
  cat("Cell Type Distribution\n")
  print(table(so@meta.data$cell_type))
}

# Check for D1/D2 MSN populations
cat("Checking For D1/D2 MSNs\n")
msn_types <- grep("DRD|D1|D2|MSN", unique(so@meta.data$cell_type), value = TRUE, ignore.case = TRUE)
cat(paste("MSN-related cell types found:", paste(msn_types, collapse = ", ")), "\n")

# Basic metadata structure
str(so@meta.data, max.level = 1)
```

##Quality Control Assessment
```{r QC Assesment}
# Clear any problematic graph objects first
so@graphs <- list()

# Calculate additional QC metrics if not present
if (!"percent.mt" %in% colnames(so@meta.data)) {
  so[["percent.mt"]] <- PercentageFeatureSet(so, pattern = "^MT-")
}
if (!"percent.ribo" %in% colnames(so@meta.data)) {
  so[["percent.ribo"]] <- PercentageFeatureSet(so, pattern = "^RP[SL]")
}

# QC summaries
summary(so@meta.data$nFeatures_RNA)
summary(so@meta.data$nCount.RNA)
summary(so@meta.data$percent.ribo)

# QC plots
p1 <- VlnPlot(so, features = c("nFeatures_RNA", "nCount.RNA", "percent.ribo"), ncol = 3, pt.size = 0.1)
print(p1)
ggsave("figures/QC_violin_plots.png", p1, width = 15, height = 6)

p2 <- FeatureScatter(so, feature1 = "nCount.RNA", feature2 = "nFeatures_RNA") + geom_smooth(method = "lm")
p3 <- FeatureScatter(so, feature1 = "nCount.RNA", feature2 = "percent.ribo") + geom_smooth(method = "lm")
p4 <- p2 + p3
print(p4)
ggsave("figures/QC_scatter_plots.png", p4, width = 12, height = 6)
```

##Data Filtering and Quality Control

```{r filtering}
cat("Before Filtering\n")
cat(paste("Cells:", ncol(so)), "\n")
cat(paste("Genes:", nrow(so)), "\n")

if ("cell_type" %in% colnames(so@meta.data)) {
  cat("Cell Type Distribution Before Filtering\n")
  print(table(so@meta.data$cell_type))
}

# Apply filtering based on QC metrics
so <- subset(so, subset = nFeatures_RNA > 200 &
                        nFeatures_RNA < 8000 &
                        nCount.RNA > 1000 &
                        nCount.RNA < 80000 &
                        percent.ribo < 0.02)

cat("After Filtering\n")
cat(paste("Cells:", ncol(so)), "\n")
cat(paste("Genes:", nrow(so)), "\n")

if ("cell_type" %in% colnames(so@meta.data)) {
  cat("Cell Type Distribution After Filtering\n")
  print(table(so@meta.data$cell_type))
}
```

##Data Normalization and Scaling

```{r normalize scale}
DefaultAssay(so) <- "RNA"

# Normalize if needed
if (is.null(so[["RNA"]]@data) || ncol(so[["RNA"]]@data) == 0) {
  cat("Normalizing RNA data...\n")
  so <- NormalizeData(so)
} else {
  cat("RNA data already normalized\n")
}

# Variable features
if (length(VariableFeatures(so)) == 0) {
  cat("Finding variable features...\n")
  so <- FindVariableFeatures(so, selection.method = "vst", nfeatures = 2000)
} else {
  cat("Variable features already identified\n")
}

# Plot variable features
top10 <- head(VariableFeatures(so), 10)
p5 <- VariableFeaturePlot(so)
p6 <- LabelPoints(plot = p5, points = top10, repel = TRUE)
print(p6)
ggsave("figures/Variable_Features.png", p6, width = 12, height = 8)

# Scale only variable features for speed
if (is.null(so[["RNA"]]@scale.data) || ncol(so[["RNA"]]@scale.data) == 0) {
  cat("Scaling RNA variable features...\n")
  so <- ScaleData(so, features = VariableFeatures(so))
} else {
  cat("RNA data already scaled\n")
}
```

##PCA and Dimensionality Reduction

```{r pca umap}
if (!"pca" %in% names(so@reductions)) {
  cat("Running PCA...\n")
  so <- RunPCA(so, features = VariableFeatures(so))
}

p7 <- DimPlot(so, reduction = "pca", group.by = "cell_type", label = TRUE, repel = TRUE)
print(p7)
ggsave("figures/PCA_plot.png", p7, width = 12, height = 8)

p8 <- ElbowPlot(so, ndims = 50)
print(p8)
ggsave("figures/Elbow_plot.png", p8, width = 10, height = 6)

if (!"umap" %in% names(so@reductions)) {
  cat("Running UMAP...\n")
  set.seed(1234)
  so <- RunUMAP(so, dims = 1:20)
}

p9 <- DimPlot(so, reduction = "umap", group.by = "cell_type", label = TRUE, repel = TRUE)
print(p9)
ggsave("figures/UMAP_CellType.png", p9, width = 12, height = 10)
```

##Dopamine Receptor Expression Analysis
```{r dopamine receptors}
# Key dopamine-related markers (filtered for reliably detected ones)
dopamine_markers <- c("DRD1", "DRD2", "PPP1R1B", "PDE1B", "BCL11B", "KIAA1211L", "PDE2A", "SLIT3", "NGEF")

present_markers <- dopamine_markers[dopamine_markers %in% rownames(so)]
missing_markers <- setdiff(dopamine_markers, present_markers)

cat("Dopamine Marker Availability\n")
cat(paste("Present:", paste(present_markers, collapse = ", ")), "\n")
cat(paste("Missing:", paste(missing_markers, collapse = ", ")), "\n")

if (length(present_markers) > 0) {
  p10 <- FeaturePlot(so, features = present_markers, ncol = 3, reduction = "umap")
  print(p10); ggsave("figures/Dopamine_Markers_FeaturePlot.png", p10, width = 15, height = 10)

  p11 <- VlnPlot(so, features = present_markers, group.by = "cell_type", ncol = 3, pt.size = 0)
  print(p11); ggsave("figures/Dopamine_Markers_ViolinPlot.png", p11, width = 15, height = 10)
}

# D1/D2 classification
if (!"D1_D2_class" %in% colnames(so@meta.data) && all(c("DRD1","DRD2") %in% rownames(so))) {
  drd1_exp <- GetAssayData(so, assay = "RNA", layer = "data")["DRD1", ]
  drd2_exp <- GetAssayData(so, assay = "RNA", layer = "data")["DRD2", ]
  so$D1_D2_class <- ifelse(drd1_exp > 1 & drd2_exp < 0.5, "D1R+",
                        ifelse(drd2_exp > 1 & drd1_exp < 0.5, "D2R+", "Mixed/Other"))
  cat("D1R/D2R Classification\n"); print(table(so$D1_D2_class))

  p12 <- DimPlot(so, group.by = "D1_D2_class", reduction = "umap",
                 cols = c("D1R+" = "#FF6B6B", "D2R+" = "#4ECDC4", "Mixed/Other" = "#95A5A6"))
  print(p12); ggsave("figures/D1R_D2R_Classification.png", p12, width = 10, height = 8)
}
```

##Subset to D1R+ and D2R+ MSNs

```{r subset msns}
cat("Identifying MSN Populations\n")

if ("cell_type" %in% colnames(so@meta.data)) {
  msn_idents <- grep("DRD1|DRD2", unique(so@meta.data$cell_type), value = TRUE)
  cat(paste("MSN cell types found:", paste(msn_idents, collapse = ", ")), "\n")
  if (length(msn_idents) > 0) {
    Idents(so) <- so$cell_type
    so_msn <- subset(so, idents = msn_idents)
  }
}
if (!exists("so_msn")) {
  if ("D1_D2_class" %in% colnames(so@meta.data)) {
    Idents(so) <- so$D1_D2_class
    so_msn <- subset(so, idents = c("D1R+", "D2R+"))
  } else {
    cat("No clear MSN populations identified. Using all cells.\n")
    so_msn <- so
  }
}

cat("MSN Subset Summary\n")
cat(paste("MSN cells:", ncol(so_msn)), "\n")
cat(paste("MSN genes:", nrow(so_msn)), "\n")

DefaultAssay(so_msn) <- "RNA"

# Filter low-expression genes
non_zero_genes <- rownames(so_msn)[Matrix::rowSums(GetAssayData(so_msn, layer = "counts")) > 0]
so_msn <- subset(so_msn, features = non_zero_genes)
cat(paste("Genes after filtering:", nrow(so_msn)), "\n")

if (ncol(so_msn) > 100) {
  p13 <- DimPlot(so_msn, reduction = "umap", group.by = ifelse("cell_type" %in% colnames(so_msn@meta.data), "cell_type", "D1_D2_class"), label = TRUE)
  print(p13); ggsave("figures/MSN_Subset_UMAP.png", p13, width = 10, height = 8)
}
```

##Differential Expression Analysis: D1R+ vs D2R+ (Single-cell)

```{r differential expression}
if (ncol(so_msn) > 50) {
  cat("Differential Expression Analysis (single-cell)\n")

  if ("cell_type" %in% colnames(so_msn@meta.data) && any(grepl("DRD1|DRD2", so_msn@meta.data$cell_type))) {
    Idents(so_msn) <- so_msn$cell_type
    ident1 <- grep("DRD1", levels(Idents(so_msn)), value = TRUE)[1]
    ident2 <- grep("DRD2", levels(Idents(so_msn)), value = TRUE)[1]
  } else if ("D1_D2_class" %in% colnames(so_msn@meta.data)) {
    Idents(so_msn) <- so_msn$D1_D2_class
    ident1 <- "D1R+"
    ident2 <- "D2R+"
  }

  if (exists("ident1") && exists("ident2")) {
    cat(paste("Comparing:", ident1, "vs", ident2, "\n"))

    markers_drd1_vs_drd2 <- FindMarkers(
      so_msn,
      ident.1 = ident1,
      ident.2 = ident2,
      only.pos = FALSE,
      min.pct = 0.1,
      logfc.threshold = 0 # get all, we will threshold ourselves
    )

    markers_drd1_vs_drd2$gene <- rownames(markers_drd1_vs_drd2)
    write.csv(markers_drd1_vs_drd2, "tables/DE_DRD1_vs_DRD2_all.csv", row.names = FALSE)

    # Apply significance criteria: abs(FC) > 1, padj < 0.05
    sc_sig <- markers_drd1_vs_drd2 %>%
      filter(!is.na(p_val_adj)) %>%
      filter(p_val_adj < 0.05, abs(avg_log2FC) > 1)

    write.csv(sc_sig, "tables/DE_DRD1_vs_DRD2_significant.csv", row.names = FALSE)

    cat("Top Differential Genes (significant)\n")
    print(head(sc_sig[order(sc_sig$p_val_adj), ], 10))

    # Volcano with significance & correct legend mapping
    dfv <- markers_drd1_vs_drd2 %>%
      mutate(
        sig = ifelse(!is.na(p_val_adj) & p_val_adj < 0.05 & abs(avg_log2FC) > 1, "significant", "ns"),
        log10_padj = -log10(p_val_adj + 1e-300),
        dir = ifelse(avg_log2FC > 0, paste0(ident1, " enriched"), paste0(ident2, " enriched"))
      )

    p14 <- ggplot(dfv, aes(x = avg_log2FC, y = log10_padj)) +
      geom_point(aes(alpha = sig == "significant", color = dir), size = 1) +
      scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.3)) +
      labs(x = "Average log2(Fold Change)", y = "-log10(Adjusted P-value)",
           title = paste(ident1, "vs", ident2, "- Differential Expression"),
           color = "Enriched in") +
      theme_classic() +
      geom_hline(yintercept = -log10(0.05), linetype = "dashed", alpha = 0.5) +
      geom_vline(xintercept = c(-1, 1), linetype = "dashed", alpha = 0.5)
    print(p14); ggsave("figures/Volcano_Plot_D1_vs_D2.png", p14, width = 10, height = 8)

    # Highlight top DEGs and epigenetic regulators on volcano
    # (top 15 by padj and any epi genes that are significant)
    epi_genes_master <- c("DNMT1","DNMT3A","DNMT3B","TET1","TET2","TET3","UHRF1",
                          "EZH2","EZH1","SUZ12","EED","KMT2A","KMT2D","SETD1A","SETD1B",
                          "KMT5A","KMT5B","KMT5C","EHMT1","EHMT2","SUV39H1","SUV39H2",
                          "KDM1A","KDM1B","KDM4A","KDM4B","KDM4C","KDM5A","KDM5B","KDM6A","KDM6B",
                          "HDAC1","HDAC2","HDAC3","SIRT1","SIRT2","SIRT6",
                          "SMARCA4","SMARCA2","SMARCB1","CHD1","CHD2","CHD7","CHD8",
                          "MECP2","MBD1","MBD2","MBD3","CTCF","SATB1","SATB2")

    present_epi_genes <- intersect(epi_genes_master, rownames(so_msn))
    sc_sig_epi <- sc_sig %>% filter(gene %in% present_epi_genes)

    top_labels <- sc_sig %>% arrange(p_val_adj) %>% slice_head(n = 15) %>% pull(gene)
    label_genes <- union(top_labels, sc_sig_epi$gene)

    p14_lab <- p14 +
      geom_text_repel(
        data = dfv %>% filter(gene %in% label_genes),
        aes(label = gene),
        size = 3, max.overlaps = 50
      )
    print(p14_lab); ggsave("figures/Volcano_Plot_D1_vs_D2_highlighted.png", p14_lab, width = 10, height = 8)

    # Heatmap of top significant markers
    top_markers <- sc_sig %>%
      arrange(desc(abs(avg_log2FC))) %>%
      slice_head(n = 50) %>%
      pull(gene)

    if (length(top_markers) > 0) {
      # Scale only the top genes for heatmap speed
      so_msn <- ScaleData(so_msn, features = top_markers, verbose = FALSE)
      p15 <- DoHeatmap(so_msn, features = top_markers,
                       group.by = ifelse("cell_type" %in% colnames(so_msn@meta.data), "cell_type","D1_D2_class"),
                       size = 3) +
        scale_fill_gradientn(colors = c("skyblue", "white", "coral"))
      print(p15); ggsave("figures/Heatmap_Top_DE_Genes.png", p15, width = 12, height = 8)
    }
  }
} else {
  cat("Insufficient cells for differential expression analysis\n")
}
```

##Gene Ontology & KEGG Enrichment (Single-cell significant DEs)

```{r GO KEGG enrichment}
if (exists("sc_sig") && nrow(sc_sig) >= 10) {
  cat("Starting GO & KEGG Enrichment (single-cell significant)\n")

  sig_genes <- unique(sc_sig$gene)

  # Ensure valid SYMBOLs for GO
  valid_symbols <- sig_genes[sig_genes %in% keys(org.Hs.eg.db, keytype = "SYMBOL")]

  # GO enrichment (BP/MF/CC)
  run_go <- function(genes, ontology, labelprefix) {
    ego <- enrichGO(
      gene = genes, OrgDb = org.Hs.eg.db, keyType = "SYMBOL",
      ont = ontology, pAdjustMethod = "BH", pvalueCutoff = 0.05, qvalueCutoff = 0.2
    )
    if (is.null(ego) || nrow(as.data.frame(ego)) == 0) return(NULL)

    out_df <- as.data.frame(ego)
    write.csv(out_df, file = paste0("tables/GO_Enrichment_", labelprefix, ".csv"), row.names = FALSE)

    p_bar <- barplot(ego, showCategory = 15, title = paste("GO", labelprefix))
    ggsave(paste0("figures/GO_", labelprefix, "_Barplot.png"), plot = p_bar, width = 12, height = 8)

    p_dot <- dotplot(ego, showCategory = 15, title = paste("GO", labelprefix))
    ggsave(paste0("figures/GO_", labelprefix, "_Dotplot.png"), plot = p_dot, width = 12, height = 8)

    print(p_bar); print(p_dot)
    invisible(ego)
  }

  ego_bp <- run_go(valid_symbols, "BP", "Biological_Process")
  ego_mf <- run_go(valid_symbols, "MF", "Molecular_Function")
  ego_cc <- run_go(valid_symbols, "CC", "Cellular_Component")

  # KEGG enrichment (requires ENTREZ IDs)
  symbol2entrez <- bitr(valid_symbols, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db) %>% distinct(SYMBOL, .keep_all = TRUE)
  if (!is.null(symbol2entrez) && nrow(symbol2entrez) >= 10) {
    ekegg <- enrichKEGG(gene = symbol2entrez$ENTREZID, organism = "hsa", pvalueCutoff = 0.05)
    if (!is.null(ekegg) && nrow(as.data.frame(ekegg)) > 0) {
      kegg_df <- as.data.frame(ekegg)
      write.csv(kegg_df, "tables/KEGG_Enrichment_singlecell.csv", row.names = FALSE)

      k_bar <- barplot(ekegg, showCategory = 15, title = "KEGG Pathways (single-cell)")
      k_dot <- dotplot(ekegg, showCategory = 15, title = "KEGG Pathways (single-cell)")
      ggsave("figures/KEGG_singlecell_Barplot.png", k_bar, width = 12, height = 8)
      ggsave("figures/KEGG_singlecell_Dotplot.png", k_dot, width = 12, height = 8)
      print(k_bar); print(k_dot)
    } else {
      cat("No significant KEGG terms found (single-cell)\n")
    }
  } else {
    cat("Too few mappable symbols for KEGG (single-cell)\n")
  }
} else {
  cat("Too few significant DE genes for enrichment (single-cell)\n")
}
```

##Epigenetic Regulator Expression Analysis

```{r epigenetic regulators}
epi_genes <- c(
  # DNA methylation
  "DNMT1","DNMT3A","DNMT3B","TET1","TET2","TET3","UHRF1",
  # Histone writers
  "EZH2","EZH1","SUZ12","EED","KMT2A","KMT2D","SETD1A","SETD1B",
  "KMT5A","KMT5B","KMT5C","EHMT1","EHMT2","SUV39H1","SUV39H2",
  # Histone erasers
  "KDM1A","KDM1B","KDM4A","KDM4B","KDM4C","KDM5A","KDM5B","KDM6A","KDM6B",
  "HDAC1","HDAC2","HDAC3","SIRT1","SIRT2","SIRT6",
  # Chromatin remodeling
  "SMARCA4","SMARCA2","SMARCB1","CHD1","CHD2","CHD7","CHD8",
  # DNA binding/regulation
  "MECP2","MBD1","MBD2","MBD3","CTCF","SATB1","SATB2"
)

present_epi_genes <- intersect(epi_genes, rownames(so_msn))
missing_epi_genes  <- setdiff(epi_genes, present_epi_genes)

cat(paste("Present epigenetic genes:", length(present_epi_genes)), "\n")
cat(paste("Missing epigenetic genes:", length(missing_epi_genes)), "\n")

if (length(present_epi_genes) > 0) {
  # Use up to 10 genes for compact violins
  top_epi_genes <- present_epi_genes[1:min(10, length(present_epi_genes))]

  p18 <- VlnPlot(so_msn, features = top_epi_genes,
                 group.by = ifelse("cell_type" %in% colnames(so_msn@meta.data), "cell_type","D1_D2_class"),
                 pt.size = 0, ncol = 4) +
         theme_minimal() + ggtitle("Expression of Epigenetic Regulators by Group")
  ggsave("figures/Epigenetic_Regulators_ViolinPlot.png", p18, width = 16, height = 12); print(p18)

  # Heatmap over all present epigenetic regulators
  if (length(present_epi_genes) >= 4) {
    so_msn <- ScaleData(so_msn, features = present_epi_genes, verbose = FALSE)
    p19 <- DoHeatmap(so_msn,
                     features = present_epi_genes,
                     group.by = ifelse("cell_type" %in% colnames(so_msn@meta.data), "cell_type","D1_D2_class"),
                     size = 3) +
           scale_fill_gradientn(colors = c("skyblue", "white", "coral")) +
           ggtitle("Heatmap of Epigenetic Regulator Expression")
    ggsave("figures/Epigenetic_Regulators_Heatmap.png", p19, width = 12, height = 10); print(p19)
  }

  # DotPlot
  if (length(present_epi_genes) >= 4) {
    p_dot <- DotPlot(so_msn, features = present_epi_genes,
                     group.by = ifelse("cell_type" %in% colnames(so_msn@meta.data), "cell_type","D1_D2_class")) +
             RotatedAxis() +
             scale_color_gradientn(colors = c("skyblue", "white", "coral")) +
             ggtitle("DotPlot of Epigenetic Regulator Expression")
    ggsave("figures/Epigenetic_Regulators_DotPlot.png", p_dot, width = 14, height = 8); print(p_dot)
  }

  # Differential epigenetic regulators within single-cell DE results
  if (exists("sc_sig")) {
    epi_de_results <- sc_sig %>%
      filter(gene %in% present_epi_genes) %>%
      arrange(p_val_adj)
    if (nrow(epi_de_results) > 0) {
      write.csv(epi_de_results, "tables/Epigenetic_Regulators_DE_singlecell.csv", row.names = FALSE)
      print(head(epi_de_results, 15))
    }
  }
}
```

##Pseudobulk Differential Expression Analysis

```{r pseudobulk de}
if (!"D1_D2_class" %in% colnames(so_msn@meta.data)) stop("D1/D2 classification is missing.")

# Simulated sample IDs if absent (documented)
if (!"sample" %in% colnames(so_msn@meta.data)) {
  set.seed(123)
  so_msn$sample <- NA
  for (class in unique(so_msn$D1_D2_class)) {
    class_cells <- which(so_msn$D1_D2_class == class)
    so_msn$sample[class_cells] <- paste0("Sample_", class, "_", sample(1:3, length(class_cells), replace = TRUE))
  }
}

counts <- GetAssayData(so_msn, slot = "counts")
meta_df <- so_msn@meta.data[, c("sample", "D1_D2_class")]

pb_counts_list <- lapply(unique(meta_df$sample), function(s) {
  cells <- rownames(meta_df[meta_df$sample == s, ])
  group <- unique(meta_df[meta_df$sample == s, "D1_D2_class"])
  if (length(group) == 1 && length(cells) > 0) Matrix::rowSums(counts[, cells, drop = FALSE]) else NULL
})

pb_counts <- do.call(cbind, pb_counts_list)
colnames(pb_counts) <- unique(meta_df$sample)

pb_meta <- data.frame(
  sample = colnames(pb_counts),
  group = sapply(colnames(pb_counts), function(s) unique(meta_df[meta_df$sample == s, "D1_D2_class"]))
)

keep_groups <- c("D1R+", "D2R+")
keep_samples <- pb_meta$group %in% keep_groups
pb_counts <- pb_counts[, keep_samples]
pb_meta   <- pb_meta[keep_samples, , drop = FALSE]
pb_meta$group <- factor(pb_meta$group, levels = keep_groups)

dge <- DGEList(counts = pb_counts, group = pb_meta$group)
dge <- dge[filterByExpr(dge), , keep.lib.sizes = FALSE]
dge <- calcNormFactors(dge)

design <- model.matrix(~0 + pb_meta$group)
colnames(design) <- make.names(levels(pb_meta$group))

dge <- estimateDisp(dge, design)
fit <- glmFit(dge, design)
contrast <- makeContrasts(D1R_vs_D2R = D1R. - D2R., levels = design)
lrt <- glmLRT(fit, contrast = contrast)

pb_de_results <- topTags(lrt, n = Inf)$table %>%
  rownames_to_column("gene") %>%
  arrange(FDR)
write.csv(pb_de_results, "tables/Pseudobulk_DE_D1R_vs_D2R_all.csv", row.names = FALSE)

# Apply significance criteria: abs(logFC) > 1 & FDR < 0.05
pb_sig <- pb_de_results %>% filter(FDR < 0.05, abs(logFC) > 1)
write.csv(pb_sig, "tables/Pseudobulk_DE_D1R_vs_D2R_significant.csv", row.names = FALSE)

# Volcano (pseudobulk) + highlights
pb_de_results$log10FDR <- -log10(pb_de_results$FDR + 1e-300)
pb_de_results$dir <- ifelse(pb_de_results$logFC > 0, "D1R+ enriched", "D2R+ enriched")
pb_de_results$sig <- ifelse(pb_de_results$FDR < 0.05 & abs(pb_de_results$logFC) > 1, "significant", "ns")

p_pb_volcano <- ggplot(pb_de_results, aes(x = logFC, y = log10FDR)) +
  geom_point(aes(alpha = sig == "significant", color = dir), size = 1) +
  scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.3)) +
  labs(title = "Pseudobulk DE: D1R+ vs D2R+",
       x = "log2 Fold Change", y = "-log10 FDR", color = "Enriched in") +
  theme_classic() +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", alpha = 0.5)
ggsave("figures/Pseudobulk_Volcano_Plot.png", p_pb_volcano, width = 10, height = 8)
print(p_pb_volcano)

# Highlight top pseudobulk DEGs + epigenetic regulators
pb_top_labels <- pb_sig %>% arrange(FDR) %>% slice_head(n = 15) %>% pull(gene)
pb_epi_labels <- intersect(pb_sig$gene, present_epi_genes)
pb_labels <- union(pb_top_labels, pb_epi_labels)

p_pb_volcano_lab <- p_pb_volcano +
  geom_text_repel(
    data = pb_de_results %>% filter(gene %in% pb_labels),
    aes(label = gene),
    size = 3, max.overlaps = 50
  )
ggsave("figures/Pseudobulk_Volcano_Plot_highlighted.png", p_pb_volcano_lab, width = 10, height = 8)
print(p_pb_volcano_lab)

# Epigenetic subset (pseudobulk)
epi_pe_de_results <- pb_sig %>%
  filter(gene %in% present_epi_genes) %>% arrange(FDR)
write.csv(epi_pe_de_results, "tables/Epigenetic_Regulators_Pseudobulk_DE.csv", row.names = FALSE)
print(head(epi_pe_de_results, 15))
```

##GO & KEGG Enrichment for Pseudobulk Significant DE

```{r GO & KEGG pb}
if (exists("pb_sig") && nrow(pb_sig) >= 10) {
  cat("Starting GO & KEGG Enrichment (pseudobulk significant)\n")

  pb_genes <- unique(pb_sig$gene)
  valid_symbols_pb <- pb_genes[pb_genes %in% keys(org.Hs.eg.db, keytype = "SYMBOL")]

  run_go_pb <- function(genes, ontology, labelprefix) {
    ego <- enrichGO(
      gene = genes, OrgDb = org.Hs.eg.db, keyType = "SYMBOL",
      ont = ontology, pAdjustMethod = "BH", pvalueCutoff = 0.05, qvalueCutoff = 0.2
    )
    if (is.null(ego) || nrow(as.data.frame(ego)) == 0) return(NULL)
    out_df <- as.data.frame(ego)
    write.csv(out_df, file = paste0("tables/Pseudobulk_GO_Enrichment_", labelprefix, ".csv"), row.names = FALSE)

    p_bar <- barplot(ego, showCategory = 15, title = paste("GO", labelprefix))
    p_dot <- dotplot(ego, showCategory = 15, title = paste("GO", labelprefix))
    ggsave(paste0("figures/Pseudobulk_GO_", labelprefix, "_Barplot.png"), p_bar, width = 12, height = 8)
    ggsave(paste0("figures/Pseudobulk_GO_", labelprefix, "_Dotplot.png"), p_dot, width = 12, height = 8)
    print(p_bar); print(p_dot)
    invisible(ego)
  }

  ego_pb_bp <- run_go_pb(valid_symbols_pb, "BP", "Biological_Process")
  ego_pb_mf <- run_go_pb(valid_symbols_pb, "MF", "Molecular_Function")
  ego_pb_cc <- run_go_pb(valid_symbols_pb, "CC", "Cellular_Component")

  symbol2entrez_pb <- bitr(valid_symbols_pb, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db) %>% distinct(SYMBOL, .keep_all = TRUE)
  if (!is.null(symbol2entrez_pb) && nrow(symbol2entrez_pb) >= 10) {
    ekegg_pb <- enrichKEGG(gene = symbol2entrez_pb$ENTREZID, organism = "hsa", pvalueCutoff = 0.05)
    if (!is.null(ekegg_pb) && nrow(as.data.frame(ekegg_pb)) > 0) {
      kegg_pb_df <- as.data.frame(ekegg_pb)
      write.csv(kegg_pb_df, "tables/KEGG_Enrichment_pseudobulk.csv", row.names = FALSE)
      k_bar_pb <- barplot(ekegg_pb, showCategory = 15, title = "KEGG Pathways (pseudobulk)")
      k_dot_pb <- dotplot(ekegg_pb, showCategory = 15, title = "KEGG Pathways (pseudobulk)")
      ggsave("figures/KEGG_pseudobulk_Barplot.png", k_bar_pb, width = 12, height = 8)
      ggsave("figures/KEGG_pseudobulk_Dotplot.png", k_dot_pb, width = 12, height = 8)
      print(k_bar_pb); print(k_dot_pb)
    } else {
      cat("No significant KEGG terms found (pseudobulk)\n")
    }
  } else {
    cat("Too few mappable symbols for KEGG (pseudobulk)\n")
  }
} else {
  cat("No sufficient significant DEs for pseudobulk enrichment\n")
}
```

##Overlapping DE: Single-cell vs Pseudobulk

```{r overlap de}
if (exists("markers_drd1_vs_drd2") && exists("pb_de_results")) {
  sc_genes <- rownames(markers_drd1_vs_drd2)
  pb_genes <- pb_de_results$gene
  overlapping_genes <- intersect(sc_genes, pb_genes)
  cat("Number of overlapping DE genes:", length(overlapping_genes), "\n")

  overlap_sc <- markers_drd1_vs_drd2[overlapping_genes, , drop = FALSE]
  overlap_pb <- pb_de_results %>% filter(gene %in% overlapping_genes)

  overlap_merged <- merge(
    overlap_sc %>% dplyr::select(avg_log2FC, p_val_adj) %>% dplyr::rename(sc_log2FC = avg_log2FC, sc_padj = p_val_adj),
    overlap_pb %>% dplyr::select(gene, logFC, FDR) %>% dplyr::rename(pb_log2FC = logFC, pb_FDR = FDR),
    by.x = "row.names", by.y = "gene"
  )
  colnames(overlap_merged)[1] <- "gene"

  print(head(overlap_merged[order(overlap_merged$sc_padj + overlap_merged$pb_FDR), ], 10))
  write.csv(overlap_merged, "tables/Overlapping_DEGs_SC_vs_PB.csv", row.names = FALSE)

  # Highlight top 20 disagreements
  overlap_merged$abs_diff <- abs(overlap_merged$pb_log2FC - overlap_merged$sc_log2FC)
  overlap_merged <- overlap_merged[order(-overlap_merged$abs_diff), ]
  overlap_merged$highlight <- "no"
  overlap_merged$highlight[seq_len(min(20, nrow(overlap_merged)))] <- "yes"

  p_overlap <- ggplot(overlap_merged, aes(x = pb_log2FC, y = sc_log2FC)) +
    geom_point(aes(color = highlight), alpha = 0.7) +
    geom_smooth(method = "lm", se = FALSE) +
    scale_color_manual(values = c("no" = "black", "yes" = "blue")) +
    geom_text_repel(data = subset(overlap_merged, highlight == "yes"),
                    aes(label = gene), size = 3, max.overlaps = 20) +
    labs(x = "Pseudobulk log2FC", y = "Single-cell log2FC",
         title = "Overlap of DE Genes: Single-cell vs Pseudobulk") +
    theme_classic() + theme(legend.position = "none")
  ggsave("figures/Overlap_DEGs_log2FC_Comparison_auto_highlighted.png", p_overlap, width = 8, height = 6)
  print(p_overlap)
} else {
  cat("One or both DE result objects not found.\n")
}

```

##Summary and Data Export

```{r summary export}
cat("Analysis Summary\n")

cat(paste("Total cells in full dataset:", ncol(so)), "\n")
cat(paste("MSN cells analyzed:", ncol(so_msn)), "\n")
cat(paste("Total genes (MSN):", nrow(so_msn)), "\n")
cat(paste("Epigenetic regulators detected:", length(present_epi_genes)), "\n")

if (exists("sc_sig")) {
  sc_sig_genes <- nrow(sc_sig)
  cat(paste("Significant DE genes (single-cell, abs(log2FC)>1 & padj<0.05):", sc_sig_genes), "\n")
}

if (exists("pb_sig")) {
  pb_sig_genes <- nrow(pb_sig)
  cat(paste("Significant DE genes (pseudobulk, abs(log2FC)>1 & FDR<0.05):", pb_sig_genes), "\n")
}

if (exists("overlap_merged")) {
  cat(paste("Overlapping DE genes between single-cell and pseudobulk:", nrow(overlap_merged)), "\n")
  cat(paste("Top disagreement genes highlighted in plot:", sum(overlap_merged$highlight == "yes")), "\n")
}

saveRDS(so, "tables/Processed_Full_Dataset.rds")
saveRDS(so_msn, "tables/Filtered_MSN_Dataset.rds")

analysis_summary <- data.frame(
  Metric = c("Total cells (filtered)", "MSN cells", "Total genes (MSN)",
             "Variable features (MSN object)", "Epigenetic regulators detected",
             "Significant DE genes (single-cell)", "Significant DE genes (pseudobulk)"),
  Value = c(
    ncol(so),
    ncol(so_msn),
    nrow(so_msn),
    length(VariableFeatures(so_msn)),
    length(present_epi_genes),
    if (exists("sc_sig")) nrow(sc_sig) else NA,
    if (exists("pb_sig")) nrow(pb_sig) else NA
  )
)

write.csv(analysis_summary, "tables/Analysis_Summary.csv", row.names = FALSE)
print(analysis_summary)

cat("Analysis Complete\nCheck the 'figures/' and 'tables/' directories for outputs\n")
```

